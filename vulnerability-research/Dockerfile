FROM python:3.13-slim

RUN apt-get update && apt-get install -y \
    wget unzip git openssl gcc \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /opt

RUN git clone --recursive https://github.com/web2py/web2py.git

RUN mkdir -p /opt/ssl
RUN openssl req -x509 -newkey rsa:2048 -keyout /opt/ssl/key.pem -out /opt/ssl/cert.pem -days 365 -nodes -subj "/CN=localhost"

RUN chown -R www-data:www-data /opt
EXPOSE 8000
ENV PYTHONDONTWRITEBYTECODE=1

COPY ./src/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

RUN echo "uoftctf{is_this_web2py_or_web2shell?!?!?!!}" > /root/flag.txt && \
    chmod 400 /root/flag.txt && \
    chown root:root /root/flag.txt

COPY ./src/readflag.c /readflag.c
RUN gcc /readflag.c -o /readflag
RUN rm /readflag.c
RUN chmod 4755 /readflag

USER www-data

EXPOSE 5000

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]